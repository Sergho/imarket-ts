# imarket

### _Backend_ приложение интернет-магазина написанное на NodeJS с использованием TypeORM

## Перед запуском

Перед запуском в директории с проектом необходимо выполнить команду
```bash
$ npm i
```

Это установит зависимости для __imarket__

Более того необходимо установить дамп БД на сервере. Дамп содержится в файле `imarket.sql`. Для установки необходимо:
### Windows
1. Перейти в директорию, куда был установлен PostgreSQL. По умолчанию это `C:\Program Files\PostgreSQL\версия\bin`
2. Выполнить следующий скрипт:
   ```bash
   $ psql -U имя_пользователя -d имя_базы_данных -f путь_к_файлу.sql
   ```
   Где:
   + имя_пользователя - имя пользователя, имеющего права доступа к базе данных
   + имя_базы_данных - имя базы данных, на которую вы хотите применить дамп
   + путь_к_файлу.sql - путь к файлу `imarket.sql`
3. После этого потребуется ввести пароль администратора, и дамп будет успешно установлен

## Использование приложения

```bash
$ npm start
```

Это запустит сервер и позволит ему принимать и обрабатывать запросы

## Сущности и их поля

+ `User` - __пользователь__
  + `id*` - идентификатор __пользователя__
  + `first_name` - основное имя
  + `last_name` - фамилия
  + `mid_name` - отчество
  + `email*` - адрес электронной почты (уникальный для каждого)
  + `password_hash*` - хэш пароля
  + `role*` - __роль пользователя__ (по умолчанию `Покупатель`)

+ `Role` - __роль__ __пользователя__
  + `id*` - идентификатор __роли__
  + `name*` - название __роли__

+ `Product` - __товар__
  + `id*` - идентификатор __товара__
  + `name*` - название __товара__
  + `supplier` - __поставщик__ __товара__
  + `type` - __тип товара__
  + `price*` - цена __товара__
  + `description` - описание __товара__

+ `Supplier` - __поставщик__ __товара__
  + `id*` - идентификатор __поставщика__
  + `name*` - название __поставщика__

+ `ProductType` - __тип товара__
  + `id*` - идентификатор __типа товара__
  + `name*` - название __типа товара__

+ `Item` - __позиция__ (используется в корзине и заказе)
  + `id*` - идентификатор __позиции__ (разные системы идентификаторов у __позиций__ из __корзины__ и __позиций__ из __заказа__)
  + `product*` - __товар__ соответствующий __позиции__
  + `amount*` - количество единиц __товара__ в позиции

+ `ShoppingCart` - __корзина__ __пользователя__
  + `id*` - идентификатор __корзины__
  + `owner*` - __пользователь__, которому принадлежит __корзина__
  + `items*` - список __позиций__ в __корзине__

+ `Order` - __заказ__
  + `id*` - идентификатор __заказа__
  + `owner*` - владелец __заказа__
  + `date*` - дата создания __заказа__
  + `items*` - список __позиций__, входящих в __заказ__

## Возможные запросы

Ниже приведён список запросов для взаимодействия с __imarket__

### Для неавторизованного пользователя

+ `POST /auth/register` - регистрация (создание) __пользователя__.
  + Передача данных запроса по `POST body`
  + Данные запроса
    + `email*` - адрес электронной почты __пользователя__
    + `password*` - пароль __пользователя__
    + `firstName` - имя __пользователя__
    + `lastName` - фамилия __пользователя__
    + `midName` - отчество __пользователя__
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `created` - созданный __пользователь__

+ `POST /auth/login` - авторизация
  + Передача данных запроса по `POST body`
  + Данные запроса
    + `email*` - адрес электронной почты __пользователя__
    + `password*` - пароль __пользователя__
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `token` - __JWT__ токен для __Bearer__ авторизации

### Для покупателя (и администратора как частного его вида)

Для авторизованного покупателя токен для авторизации передается в __HTTP__ заголовке `Authorization` в формате `Bearer токен`

+ `GET /users/self` - получение данных о себе
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `user` - текущий авторизованный __пользователь__

+ `GET /products` - получение данных о всех __товарах__
  + Передача данных запроса по `query string`
  + Данные запроса
    + `limit` - максимальное количество полученных __товаров__
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `products` - список всех __товаров__

+ `GET /products/:id` - получение данных об одном __товаре__ с идентификатором `:id`
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `product` - найденный __товар__

+ `GET /cart` - получение данных своей __корзины__
  + Передача данных запроса по `query string`
  + Данные запроса
    + `limit` - максимальное количество полученных __позиций__ в __корзине__
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `cart` - __корзина__ текущего авторизованного __пользователя__

+ `POST /cart` - добавление __позиции__ в свою __корзину__
  + Передача данных запроса по `POST body`
  + Данные запроса
    + `productId*` - идентификатор __товара__, который нужно добавить в __корзину__
    + `amount*` - количество единиц __товара__ в новой __позиции__
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `item` - добавленная __позиция__

+ `DELETE /cart/:id` - удаление __позиции__, который соответствует __товару__ с идентификатором `:id`, из своей __корзины__
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `deleted` - удалённая __позиция__

+ `POST /orders` - создание нового __заказа__, по умолчанию заполняется __позициями__ из __корзины__ текущего авторизованного __пользователя__
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `order` - созданный __заказ__

+ `GET /orders/self` - получение всех __заказов__, принадлежащих текущемму авторизованному __пользователю__
  + Передача данных запроса по `query string`
  + Данные запроса
    + `limit` - максимальное количество полученных __заказов__
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `orders` - список найденных __заказов__

+ `GET /orders/self/:id` - получение данных об одном __заказе__, который принадлежит текущему авторизованному __пользователю__ и имеет идентификатор `:id`
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `order` - найденный __заказ__

### Для администратора

Для администратора токен для авторизации передается аналогично предыдущему случаю

+ `GET /roles` - получение данных о всех __ролях__ __пользователей__
  + Передача данных запроса по `query string`
  + Данные запроса
    + `limit` - максимальное количество полученных __ролей__
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `roles` - список всех __ролей__

+ `GET /users` - получение данных о всех __пользователях__
  + Передача данных запроса по `query string`
  + Данные запроса
    + `limit` - максимальное количество полученных __пользователей__
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `users` - список всех __пользователей__, ограниченных количеством `limit`

+ `GET /users/:id` - получение данных о об одном __пользователе__ с идентификатором `:id`
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `user` - найденный __пользователь__

+ `PUT /users/:id` - изменение данных одного __пользователя__ с идентификатором `:id`
  + Передача данных запроса по `PUT body`
  + Данные запроса
    + `firstName` - новое имя
    + `lastName` - новая фамилия
    + `midName` - новое отчество
    + `email` - новый адрес электронной почты
    + `password` - новый пароль
    + `roleId` - новый идентификатор __роли__
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `editted` - изменённый __пользователь__

+ `DELETE /users/:id` - удаление __пользователя__ с идентификатором `:id`
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `deleted` - удалённый __пользователь__

+ `POST /products` - добавление нового __товара__
  + Передача данных запроса по `POST body`
  + Данные запроса
    + `name*` - название
    + `price*` - цена
    + `supplierId` - идентификатор __поставщика__
    + `typeId` - идентификатор __типа__ __товара__
    + `description` - описание
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `created` - созданный __товар__
  
+ `PUT /products/:id` - изменение данных одного __товара__ с идентификатором `:id`
  + Передача данных запроса по `PUT body`
  + Данные запроса
    + `name` - новое название
    + `price` - новая цена
    + `supplierId` - новый идентификатор __поставщика__
    + `typeId` - новый идентификатор __типа__ __товара__
    + `description` - новое описание
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `editted` - изменённый __товар__

+ `DELETE /products/:id` - удаление __товара__ с идентификатором `:id`
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `deleted` - удалённый __товар__

+ `GET /orders` - получение данных о всех __заказах__
  + Передача данных запроса по `query string`
  + Данные запроса
    + `limit` - максимальное количество полученных __заказов__
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `orders` - список найденных __заказов__

+ `GET /orsers/:id` - получение __заказа__ с идентификатором `:id`
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `order` - найденный __заказ__

+ `PUT /orders/:id` - изменение данных в __заказе__ с идентификатором `:id`
  + Передача данных запроса по `PUT body`
  + Данные запроса
    + `ownerId` - идентификатор нового владельца(__пользователя__) __заказа__
    + `date` - новая дата создания __заказа__ в формате `JSON DATE`
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `editted` - изменённый __заказ__

+ `POST /orders/:id/items` - добавление __позиции__ в __заказ__ c идентификатором `:id`
  + Передача данных запроса по `POST body`
  + Данные запроса
    + `productId*` - идентификатор __товара__ для новой __позиции__
    + `amount*` - количество единиц __товара__ в новой __позиции__
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `item` - новая __позиция__, добавленная в __заказ__

+ `DELETE /orders/:orderId/products/:productId` - удаление __позиции__ из __заказа__ c идентификатором `:orderId`, соответствующей __товару__ с идентификатором `:productId`
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `deleted` - __позиция__ удалённая из __заказа__

+ `DELETE /orders/:id` - удаление __заказа__ с идентификатором `:id`
  + Данные ответа
    + `message` - краткий ответ на запрос
    + `data`
      + `deleted` - удалённый __заказ__

## Используемые технологии
+ [NodeJS](https://nodejs.org/en)
  + [express](https://www.npmjs.com/package/express) - библиотека для создания __HTTP__ сервера
  + [bcrypt](https://www.npmjs.com/package/bcrypt) - библиотека шифрования паролей
  + [jsonwebtoken](https://www.npmjs.com/package/jsonwebtoken) - библиотека для работы с __JWT__ токенами
  + [pg](https://www.npmjs.com/package/pg) - библиотека для отправки запросов к БД __PostgreSQL__
  + [nodemon](https://www.npmjs.com/package/nodemon) - библиотека для автоматического перезапуска сервера(используется при разработке)
  + [typescript](https://www.typescriptlang.org) - строго типизированный язык программирования, основанный на javascript
  + [typeorm](https://typeorm.io) - инструмент для работы с базами данных в TypeScript
+ [PostgreSQL](https://www.postgresql.org/) - реляционная СУБД
+ [JSON](https://ru.wikipedia.org/wiki/JSON) - формат передачи данных

## Директория `config`

+ ### `config/JWTSecret.js`
Содержит в поле `secret` значение секретного ключа для формирования __JWT__ токена


## Директория `controllers`

Содержит контроллеры (__MVC__) для роутов

## Директория `routers`

Содержит роутеры с роутами для отдельных случаев запроса

## Директория `middleware`

Содержит ПО промежуточного уровня для отслеживания роли текущего авторизированного (или нет) пользователя